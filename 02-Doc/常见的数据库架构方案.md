## 常见的数据库架构方案

[TOC]

## 一、数据库架构原则：

### （一）高可用：

### （二）高性能：

### （三）一致性：

### （四）扩展性：

## 二、数据库架构方案

### （一）主备架构（双机热备）

**一个主库提供全部读写服务，一个备库提供数据冗余备份，故障转移（keepalive自动切换到备库）。**

![](C:\Users\wangxun183963\Desktop\数据库架构\主备.webp)

1. 高可用分析：满足高可用，主库故障，自动切换备库；业务层透明、无需修改代码和配置。
2. 高性能分析：读写操作全部在主库，备份只做备份，资源利用率只有50%，影响性能。数据库优化、增加缓存来提高性能（提升空间有限）
3. 一致性分析：读写都操作主库，不存在一致性问题。存在数据丢失的风险（同步时间差）
4. 扩展性分析：无法通过添加从库来扩展性能。
5. 可落地分析：**性能问题**，通过优化数据库和引入缓存来提高性能。**扩展性差**，通过分库分表来扩展。

### （二）双主架构（负载均衡）

**两个主库同时提供服务，负载均衡。采用分布式存储**

![](C:\Users\wangxun183963\Desktop\数据库架构\双主.webp)

1. 高可用分析：满足高可用，一个主库故障，不影响另一台主库提供服务；业务层透明、无需修改代码和配置。
2. 高性能分析：读写性能相比方案一提升一倍。
3. 一致性分析：数据存在数据一致性问题（数据一致性方案）。
4. 扩展性分析：可扩展为多主架构（但每添加一台主库，就会多一层数据同步），扩展性差，效果不明显。
5. 可落地分析：**数据一致性问题**，可通过数据一致性解决方案解决问题；**主键冲突问题**，主键统一用分布式ID生成服务生成可解决。

### （三）双主+集中式存储

两个主库同时提供服务，负载均衡。采用集中式存储

- 分布式存储（DAS）：服务器里面放着硬盘，多台服务器的话就是分布式存储，数据分散，不易于管理。
- 集中式存储（NAS/SAN）：将服务器和硬盘分开，数据都存放NAS设备中，NAS设备再级联磁盘阵列，然后多个服务器对这个NAS设备进行访问，操作，集中数据管理。

### （四）主从架构，一主多从，读写分离

**一台主库提供更新操作，多台从库提供数据读取操作，完全读写分离。**

![](C:\Users\wangxun183963\Desktop\数据库架构\一主多从.webp)

1. 高可用分析：主库单点，从库高可用，主库故障无法提供更新操作，不影响从库读取操作。
2. 高性能分析：针对读多写少的应用，读取操作将成为瓶颈，读取性能提升整体性能提升，另外，通过主库不建索引提升主库更新性能，线上从库和线下从库建立不同的索引提升读取性能（线上从库如果有多个要建立相同的索引，不然得不偿失，线下从库是平时开发人员排查线上问题的库，可建立更多的索引）。
3. 一致性分析：数据存在数据一致性问题（数据一致性方案）。
4. 扩展性分析：可通过增加从库来扩展读取性能，进而提升整体性能。同时，增加从库将有更多的从库从主库读取binlog日志，进而影响主库性能，并且数据同步完成的时间也会更长（数据延迟）。
5. 可落地分析：**数据一致性问题**，可通过数据一致性解决方案解决问题；**主库单点问题**

### （五）双主+主从架构

**双主库同时提供更新服务（负载均衡），多从提供读取服务，读写分离。**

![](C:\Users\wangxun183963\Desktop\数据库架构\双主多从.webp)

1. 高可用分析：高可用

2. 高性能分析：高性能

3. 一致性分析：数据存在数据一致性问题（数据一致性方案）。

4. 扩展性分析：可通过增加从库来扩展读取性能，进而提升整体性能。（带来的问题同方案三）

5. 可落地分析：**数据一致性问题**，可通过数据一致性解决方案解决问题；数据同步有多一层，数据延迟更严重。


## 三、数据一致性解决方案

### （一）主从数据一致性解决方案

数据同步（从库读取主库binlog日志，再执行一遍）是需要时间的，同步时间内主库和从库的数据会存在不一致的情况，如果同步过程中，有读取操作，那么读取的将是从库的老数据。

<img src="C:\Users\wangxun183963\Desktop\数据库架构\数据同步思想png.png" style="zoom: 33%;" />

![](C:\Users\wangxun183963\Desktop\数据库架构\数据同步.webp)

1. **直接忽略**

   如果业务允许延时存在，那就不去管它。

2. **强制读主**

   主备架构方案，读写都走主库，通过缓存来扩展数据库读性能。（缓存挂了，可能会产生雪崩现象，一般采用分布式缓存）。

3. **选择读主**

   写操作时根据库、表和业务特征生成一个key放到cache里并设置过期时间（大于主从数据同步时间）。读取操作时同样生成key先去查cache，在判断是否命中，若命中则读主库，否则读从库（代价是多一次缓存读写，基本可以忽略）。

   ![](C:\Users\wangxun183963\Desktop\数据库架构\选择读主.webp)

4. **半同步复制**

   半同步复制，等主从同步完成，写请求才返回。这可以利用数据库原生功能，实现比较简单，代价是写请求延时增长，吞吐量降低。

5. **数据库中间件（选择读主）**

   引入开源（MyCat）或自研数据库中间件，思路同选择读主，成本较高，并且还多引入一层，增加程序复杂度。
   
   ![](C:\Users\wangxun183963\Desktop\数据库架构\中间件.webp)

### （二）DB和缓存一致性解决方案

1. 淘汰缓存
2. 写入数据库
3. 读取缓存？返回：读取数据库
4. 读取数据库后写入缓存

## 四、数据同步方案

![](C:\Users\wangxun183963\Desktop\数据库架构\数据同步02.gif)

### （一）SQL Server 数据同步方案

#### 发布订阅模式

表级数据同步，延迟低，不可自动故障转移，适用于分库基础数据同步，无法同步DDL操作。

1. **快照发布：**就是将所有要发布的内容，做成一个镜像文件，然后一次性复制到订阅服务器，两次快照之间的更新不会实时同步。这种方式占用带宽较多，因此比较适用内容不是很大，或者更新不需要很频繁的场景。
2. **事务发布：**是在第一次设置好事务复制之后，所有发布的内容都会进行镜像快照，订阅服务器收到已发布数据的初始快照后，发布服务器将事务流式传输到订阅服务器。当主服务器数据发生变更时，会通过日志传递同步给订阅服务器，数据近似于同步更新。
3. **合并发布：**合并发布是相当于两台都是主服务器，都可以对数据进行更新修改等操作，然后定时将发布服务器上的内容与订阅服务器上的内容进行合并，并根据配置保留相应内容，此种很少用。

#### 镜像传输模式

数据库镜像传输，严格来说不是主从架构，而是主备架构，将两台数据库服务器通过一台中间监控服务器关联起来，两台服务器通过镜像文件，实时同步数据（有延迟，延迟很短）。当主服务器宕机之后，监控服务器自动切换到备份服务器上。

库级同步，延迟低，故障自动转移，网络带宽占用高，引入监控服务器，适用于主备架构。

#### 日志传输模式

镜像传输模式类似，是将主数据库日志备份，发送到从服务器上，然后从服务器还原日志，更新数据。

<img src="C:\Users\wangxun183963\Desktop\数据库架构\数据同步思想png.png" style="zoom:50%;" />

此方式优点在于从服务器可以有多台从服务器，而且当主服务器脚本操作异常后，只需要在日志同步之前，及时拦截日志传输，即可保留从服务器数据，减少灾难损失；此方式相较于“复制发布”模式，还有一个有点就是无论是新增表、视图等等，都会通过日志同步给从服务器，而复制模式不行。

库级同步、延迟高，不可自动故障转移（外部控制主从），适用于主从架构。

#### Always on集群

实例级同步，无数据一致性问题，适用于集群架构，集中存储单点。

集群技术是微软提供的，可用性最高的主备方案。它是将多台服务器通过一个共享的外部存储区域（SAN），连接成一个资源共享的服务器群体，数据库文件和实例，都存放并运行在该共享区域节点上，每台服务器相当于一个节点，共同访问共享的节点实例。服务器只有一个节点处于活动状态，当活动节点出现故障，会有其他节点主动启动，取代当前故障点，整个过程只需要几秒钟，用户无法感知。

### MySQL 数据同步方案

#### 日志传输模式

mysql只支持日志传输模式。

异步复制：

全同步复制

半同步复制